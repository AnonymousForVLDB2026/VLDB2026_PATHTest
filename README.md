# PATHTest

We propose PATHTest, a metamorphic testing approach targeting the two fundamental features of graph querying: graph pattern matching and graph navigation, corresponding respectively to fixed-length pattern query and variable-length path query..

# Getting Started

Requirements:
* Java 19
* [Maven](https://maven.apache.org/)
* The graph database engines that you want to test (now supporting Neo4j, AgensGraph, MemGraph, and NebulaGraph)

# Project Structure

* src
    * main/java/org.example.PATHTest
        * common:  infrastructure
        * CypherTransform:  the mutator for PATHTest to generate mutated query
        * parsercypher: the cypher parser generated by [ANTLR](https://www.antlr.org/)
        * cypher
            * ast/standard_ast: implementation of ast structure
            * algorithm: algorithm used by PATHTest
            * gen: generators for queries, graphs, patterns, expressions
                * condition
                    * GuidedConditionGenerator.java: the condition generator for PATHTest
                * graph
                    * SlidingGraphGenerator.java: the graph generator for PATHTest
                * expr
                    * RandomExpressionGenerator.java: the expression generator for PATHTest
            * oracle: oracles
                * DifferentialNonEmptyBranchOracle.java: the oracle used by PATHTest
        * neo4j: support for neo4j database(schema, connection, options)
        * memGraph: support for memGraph database(schema, connection, options)
        * agensGraph: support for agensGraph database(schema, connection, options)
        * nebulaGraph: support for redisGraph database(schema, connection, options)

# Quick Start

## Step1: Build the target using mvn
```shell
mvn clean
mvn package
```
After the build completes, a target directory will be created in the current path. Inside it, you will find the generated JAR files. 
The file named **PATHTest-1.0.jar** is the target output generated by our method.
## Step2: Build the test graph database using Docker images or from source code.

In most cases, we use Docker images to set up the environment. We create two identical instances to execute queries before and after mutation.
For example, we can create two instances of Neo4j version5.26.7  by running the following commands at the command line:
```shell
docker run --restart always --name neo4j_1 -p 7473:7473 -p 7474:7474 -p 7687:7687 -d neo4j:5.26.7
docker run --restart always --name neo4j_2 -p 7475:7473 -p 7476:7474 -p 7688:7687 -d neo4j:5.26.7
```
The "--restart always" parameter prevents the test from stopping due to a database crash.

## Step3: Create a configuration file. 
For example, to test Neo4j, create a file named config.json and add the following content:
```json
{
  "neo4j@first":{
    "port": 7687,
    "host": "localhost",
    "username": "neo4j",
    "password": "neo4j_2025"
  },
  "neo4j@second":{
    "port": 7688,
    "host": "localhost",
    "username": "neo4j",
    "password": "neo4j_2025"
  }
}
```
## Step4: Start the testing.
Generally PATHTest can be configured and executed using the following command:
```bash
java -jar PATHTest-1.0.jar  --[database_option]... --database-instance neo4j composite
```
For example, to test Neo4j above, run the following command using the target JAR :
```shell
java -jar <pathToTarget>/PATHTest-1.0.jar  --algorithm compared3 --num-tries 100 --num-queries 1000 --max-node-num 16 --database-instance neo4j composite
```
The testing should begin, PATHTest will generate 100 graphs and for each graph it will generate 1000 queries.
The potential bugs are recorded in ```log_<targetDB>.txt``` (in this case is ```log_neo4j.txt```). All the graph database instances and test case pairs will be recorded in the ```logs``` directory for reproduction.

The list of databases currently supported by PATHTest is as follows:

```
Neo4j
MemGraph
AgensGraph
NebulaGraph
```
And testing other databases is similar to tesing Neo4j.
## Bugs Found by PATHTest
| Bug          | Link                                                       | Status    | Type  |
|--------------|------------------------------------------------------------|-----------|-------|
| neo4j1       | https://github.com/neo4j/neo4j/issues/13624                | fixed     | error |
| neo4j2       | https://github.com/neo4j/neo4j/issues/13629                | confirmed | error |
| neo4j3       | https://github.com/neo4j/neo4j/issues/13631                | fixed     | error |
| neo4j4       | https://github.com/neo4j/neo4j/issues/13643                | fixed     | logic |
| neo4j5       | https://github.com/neo4j/neo4j/issues/13648                | fixed     | error |
| neo4j6       | https://github.com/neo4j/neo4j/issues/13662                | confirmed | error |
| memgraph1    | https://github.com/memgraph/memgraph/issues/2863           | confirmed | error |
| memgraph2    | https://github.com/memgraph/memgraph/issues/2864           | confirmed | logic |
| memgraph3    | https://github.com/memgraph/memgraph/issues/2865           | confirmed | logic |
| memgraph4    | https://github.com/memgraph/memgraph/issues/2866           | confirmed | error |
| memgraph5    | https://github.com/memgraph/memgraph/issues/2872           | confirmed | logic |
| memgraph6    | https://github.com/memgraph/memgraph/issues/2873           | confirmed | logic |
| memgraph7    | https://github.com/memgraph/memgraph/issues/2874           | confirmed | logic |
| memgraph8    | https://github.com/memgraph/memgraph/issues/2876           | confirmed | logic |
| memgraph9    | https://github.com/memgraph/memgraph/issues/2877           | confirmed | logic |
| agensgraph1  | https://github.com/skaiworldwide-oss/agensgraph/issues/726 | confirmed | error |
| agensgraph2  | https://github.com/skaiworldwide-oss/agensgraph/issues/729 | fixed     | error |
| agensgraph3  | https://github.com/skaiworldwide-oss/agensgraph/issues/728 | fixed     | logic |
| agensgraph4  | https://github.com/skaiworldwide-oss/agensgraph/issues/730 | reported  | error |
| agensgraph5  | https://github.com/skaiworldwide-oss/agensgraph/issues/731 | confirmed | error |
| agensgraph6  | https://github.com/skaiworldwide-oss/agensgraph/issues/732 | confirmed | error |
| agensgraph7  | https://github.com/skaiworldwide-oss/agensgraph/issues/733 | reported  | logic |
| agensgraph8  | https://github.com/skaiworldwide-oss/agensgraph/issues/734 | reported  | logic |
| agensgraph9  | https://github.com/skaiworldwide-oss/agensgraph/issues/735 | reported  | logic |
| agensgraph10 | https://github.com/skaiworldwide-oss/agensgraph/issues/736 | reported  | logic |
| nebula1      | https://github.com/vesoft-inc/nebula/issues/6053           | confirmed | logic |
| nebula2      | https://github.com/vesoft-inc/nebula/issues/6054           | confirmed | error |
| nebula3      | https://github.com/vesoft-inc/nebula/issues/6055           | confirmed | logic |
| nebula4      | https://github.com/vesoft-inc/nebula/issues/6056           | confirmed | logic |
| nebula5      | https://github.com/vesoft-inc/nebula/issues/6057           | confirmed | error |

